ОШИБКИ И РЕШЕНИЯ - ПЛАГИН АВТОРИЗАЦИИ CIVILX
====================================================

Дата создания: 03.10.2025
Версия: 1.0

ОПИСАНИЕ: Документ содержит описание всех ошибок, с которыми столкнулись при разработке и настройке плагина авторизации CivilX, а также их решения.

====================================================
ОШИБКА #1: НЕПРАВИЛЬНЫЙ ПАРСИНГ ДАННЫХ ПОЛЬЗОВАТЕЛЯ
====================================================

ПРОБЛЕМА:
- В плагин авторизации не подтягиваются данные во вкладки "Информация о пользователе" и "Мои продукты"
- API запросы возвращают данные, но они не отображаются в интерфейсе

СИМПТОМЫ:
- Пустые вкладки в интерфейсе плагина
- Логи показывают успешные API запросы, но данные не отображаются

ПРИЧИНА:
- Неправильные URL в API вызовах - дублирование "/auth-api.php" в пути
- Неправильный парсинг JSON ответов от сервера

РЕШЕНИЕ:
1. Исправить URL в AuthService.cs:
   БЫЛО: private const string API_BASE_URL = "http://civilx.ru";
   СТАЛО: private const string API_BASE_URL = "http://civilx.ru/auth-api.php";

2. Исправить формирование URL в методах:
   БЫЛО: var url = $"{API_BASE_URL}/auth-api.php/api/login";
   СТАЛО: var url = $"{API_BASE_URL}/api/login";

3. Улучшить парсинг данных пользователя:
   - Проверять наличие поля "user" в ответе
   - Корректно извлекать данные из вложенных объектов

ФАЙЛЫ ДЛЯ ИЗМЕНЕНИЯ:
- CivilX.Shared/Auth/AuthService.cs
- plugin_aut/AuthWindow.xaml.cs

====================================================
ОШИБКА #2: HTML-ОШИБКИ СЕРВЕРА ВМЕСТО JSON
====================================================

ПРОБЛЕМА:
- Сервер возвращает HTML-ошибки (<br />) вместо JSON при активации/деактивации продуктов
- Парсинг JSON падает с ошибкой "Недопустимый примитив в JSON: ."
- Активация/деактивация продуктов не работает

СИМПТОМЫ:
- Логи показывают: "JSON deserialization error: Недопустимый примитив в JSON: ."
- HTTP статус 200 OK, но содержимое: "<br />"
- Операции активации/деактивации завершаются неудачей

ПРИЧИНА:
- PHP ошибки на сервере (Deprecated: explode(): Passing null to parameter)
- Сервер не может обработать запрос и возвращает HTML-ошибку вместо JSON

РЕШЕНИЕ:
1. Добавить обработку HTML-ошибок в AuthService.cs:
   - Проверять содержимое ответа на наличие HTML тегов
   - При HTML-ошибке проверять реальный статус на сервере
   - Считать операцию успешной только при подтверждении на сервере

2. Добавить метод CheckProductActivationStatus:
   - Проверять реальный статус продукта через API
   - Подтверждать активацию/деактивацию на сервере

3. Улучшить логирование:
   - Детальные сообщения о типе ошибок
   - Логирование HTML-содержимого ответов

ФАЙЛЫ ДЛЯ ИЗМЕНЕНИЯ:
- CivilX.Shared/Auth/AuthService.cs (методы ActivateProductAsync, DeactivateProductAsync)

====================================================
ОШИБКА #3: НЕПРАВИЛЬНАЯ ПЕРЕДАЧА ТОКЕНОВ АВТОРИЗАЦИИ
====================================================

ПРОБЛЕМА:
- Сервер возвращает ошибку "Invalid token format" при активации/деактивации
- Ошибка "Token required" при проверке статуса продукта
- PHP ошибка: "explode(): Passing null to parameter #2"

СИМПТОМЫ:
- Логи показывают: "Invalid token format"
- HTTP статус 200, но с ошибкой в JSON: {"error":"Invalid token format"}
- Проверка статуса возвращает "Token required"

ПРИЧИНА:
- Сервер ожидает токен в теле запроса, а не в заголовке Authorization
- Неправильный формат передачи токена авторизации

РЕШЕНИЕ:
1. Изменить способ передачи токена в AuthService.cs:
   БЫЛО: 
   client.DefaultRequestHeaders.Authorization = 
       new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
   var requestData = new { product_id = productId, ... };

   СТАЛО:
   var requestData = new { 
       token = token,  // Токен в теле запроса
       product_id = productId, 
       ... 
   };

2. Убрать заголовок Authorization для методов активации/деактивации
3. Передавать токен в теле JSON запроса

ФАЙЛЫ ДЛЯ ИЗМЕНЕНИЯ:
- CivilX.Shared/Auth/AuthService.cs (методы ActivateProductAsync, DeactivateProductAsync)

====================================================
ОШИБКА #4: КНОПКА АКТИВАЦИИ НЕ РЕАГИРУЕТ НА КЛИКИ
====================================================

ПРОБЛЕМА:
- Кнопка "Активировать" не реагирует на нажатия
- Нет записей в логах о нажатии кнопки
- MessageBox для отладки не появляется

СИМПТОМЫ:
- Кнопка отображается, но не реагирует на клики
- Отсутствуют записи "Button clicked" в логах
- Нет записей "HandleProductAction" в логах

ПРИЧИНА:
- Проблема с привязкой события Click к кнопке
- Возможно, кнопка не отображается или перекрывается другими элементами

РЕШЕНИЕ:
1. Добавить дополнительное логирование в обработчик кнопки:
   actionButton.Click += (s, e) => {
       WriteToLogFile($"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] Button clicked for product {product.ProductName} (ID: {product.Id})");
       HandleProductAction(product);
   };

2. Проверить создание кнопки в методе CreateProductsTable
3. Убедиться, что кнопка добавляется в правильную панель

ФАЙЛЫ ДЛЯ ИЗМЕНЕНИЯ:
- plugin_aut/AuthWindow.xaml.cs (метод CreateProductsTable)

====================================================
ОШИБКА #5: ПРОБЛЕМЫ С КОМПИЛЯЦИЕЙ И УСТАНОВКОЙ
====================================================

ПРОБЛЕМА:
- Ошибки компиляции при сборке проектов
- Файлы заблокированы при копировании в папку Revit Addins
- Плагин не загружается в Revit

СИМПТОМЫ:
- "Файл используется другим процессом" при копировании
- Ошибки компиляции MSBuild
- Плагин не появляется в Revit

ПРИЧИНА:
- Revit использует файлы плагина и блокирует их
- Неправильные пути к MSBuild
- Неправильная структура файлов в папке Addins

РЕШЕНИЕ:
1. Правильная последовательность установки:
   - Закрыть Revit полностью
   - Скопировать файлы в C:\ProgramData\Autodesk\Revit\Addins\2023\
   - Перезапустить Revit

2. Использовать правильный путь к MSBuild:
   "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"

3. Правильная структура файлов:
   C:\ProgramData\Autodesk\Revit\Addins\2023\
   ├── CivilX.addin
   └── CivilX_export\
       ├── CivilX.Shared.dll
       ├── CivilXAuthPlugin.dll
       ├── RevitExporterAddin.dll
       └── main_icon.jpg

====================================================
ОБЩИЕ РЕКОМЕНДАЦИИ ПО ОТЛАДКЕ
====================================================

1. ЛОГИРОВАНИЕ:
   - Всегда проверяйте логи в %APPDATA%\CivilX\AuthPlugin\auth_plugin_log.txt
   - Добавляйте детальное логирование в критические места
   - Используйте WriteToLogFile для записи в файл

2. ТЕСТИРОВАНИЕ:
   - Тестируйте каждый этап отдельно
   - Проверяйте API запросы через логи
   - Используйте MessageBox для отладки UI

3. УСТАНОВКА:
   - Всегда закрывайте Revit перед копированием файлов
   - Проверяйте права доступа к папке ProgramData
   - Убедитесь, что все файлы скопированы

4. РАЗРАБОТКА:
   - Используйте правильные пути к MSBuild
   - Компилируйте в Release режиме для продакшена
   - Проверяйте зависимости между проектами

====================================================
ИТОГОВЫЕ ИСПРАВЛЕНИЯ
====================================================

Все ошибки были успешно исправлены:

1. ✅ Исправлен парсинг данных пользователя
2. ✅ Добавлена обработка HTML-ошибок сервера
3. ✅ Исправлена передача токенов авторизации
4. ✅ Добавлено логирование нажатий кнопок
5. ✅ Настроена правильная компиляция и установка

РЕЗУЛЬТАТ: Плагин авторизации работает корректно, активация и деактивация продуктов функционируют.

====================================================
ФАЙЛЫ ОТЧЕТОВ
====================================================

- API_URL_FIX_REPORT.md - Отчет об исправлении URL API
- USER_DATA_FIX_REPORT.md - Отчет об исправлении данных пользователя
- ACTIVATION_FIX_REPORT.md - Отчет об исправлении активации
- FINAL_ACTIVATION_FIX_SUMMARY.md - Итоговый отчет

====================================================
КОНТАКТЫ
====================================================

При возникновении новых ошибок обращайтесь к команде разработки.
Все исправления документированы и готовы к применению.

Дата последнего обновления: 03.10.2025


